# Whisper Speech Recognition

基于 OpenAI Whisper 的语音识别工具，专为长视频设计。通过手动标记音频切割点，避免 Whisper 在处理长音频时出现的识别错误和空缺问题。

## 背景

Whisper 在处理长视频时存在以下问题：
- 识别准确率下降
- 出现大量空缺
- 时间轴错位

常见的解决方案是自动切割（如每5分钟一段），但这会截断句子，导致识别失败。本工具通过可视化界面手动标记切割点，在静音或语句间隙处切割，确保 Whisper 发挥稳定。

## 特色功能

- 🎯 **手动精准切割** - 在语句间隙标记切割点，避免识别错误
- 💾 **工作区管理** - 保存识别进度，随时恢复
- ▶️ **断点续传** - 识别中断后可继续未完成的部分
- 🔄 **单段重识别** - 对识别不准确的片段重新识别
- ⏱️ **手动时间切割** - 指定时间段切割音频片段
- 🎵 **直接音频支持** - 支持直接导入音频文件（WAV/MP3/M4A等）
- 📝 **实时进度** - 识别过程实时显示输出和进度
- 🗑️ **临时文件清理** - 一键清理识别过程的临时文件

## 技术栈

- **Rust** - 主程序语言
- **egui** - GUI 框架（immediate mode）
- **rodio** - 音频播放
- **FFmpeg** - 音视频处理
- **OpenAI Whisper** - 语音识别引擎
- **serde** - 序列化/反序列化
- **rfd** - 文件对话框

## 系统要求

- Rust 1.70+
- FFmpeg
- OpenAI Whisper

## 安装依赖

### 安装 Rust

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env
```

### 安装 FFmpeg 和 Whisper

**macOS:**
```bash
brew install ffmpeg
pip3 install openai-whisper
```

**Linux:**
```bash
sudo apt install ffmpeg
pip3 install openai-whisper
```

## 编译

```bash
cd path/to/WhisperSpeechRecognition
cargo build --release
```

编译后的可执行文件位于 `target/release/whisper-gui`。

## 运行

```bash
cargo run --release
```

或直接运行编译后的可执行文件：
```bash
./target/release/whisper-gui
```

## 使用指南

### 1. 加载文件

**方式一：拖拽文件**
- 直接拖拽视频或音频文件到窗口
- 支持格式：视频（mp4/mkv/avi等）、音频（wav/mp3/m4a/flac/ogg/opus等）
- 视频文件会自动提取音频轨道

**方式二：打开工作区**
- 点击"📁 Open Folder"加载已有工作区
- 可恢复之前的切割点和识别进度

### 2. 播放与标记

**播放控制：**
- 点击"▶ Play"/"⏸ Pause"控制播放
- 拖动进度条快速定位
- 点击时间刻度（0m, 5m, 10m...）快速跳转到指定时间

**标记切割点：**
- 在语句间隙或静音处点击"✂ Mark Cut Point"
- 重复标记所有需要切割的位置
- 可点击🗑删除错误的切割点

### 3. 音频切割

**自动切割：**
- 标记好切割点后，点击"🔪 Execute Cut"执行切割
- 程序会按标记点分割音频

**手动切割：**
- 在"✂️ Manual Cut Segment"区域输入时间范围
- 支持格式：`HH:MM:SS` 或 `MM:SS` 或 `SS`
- 例如：`0:30` 到 `1:45`（30秒到1分45秒）
- 点击"✂️ Cut Segment"切割指定片段
- 点击"🎤 Recognize Segment"识别该片段

### 4. 配置识别参数

**选择 Whisper 模型：**
- `tiny` - 最快，准确率较低
- `base` - 平衡速度和准确率（推荐）
- `small` - 较慢，准确率较高
- `medium` - 慢，准确率高
- `large` - 最慢，准确率最高
- `turbo` - 新模型，速度和准确率都很好

**选择语言：**
- 预设语言：中文、日语、英语、法语、德语、西班牙语等
- 自动识别：让 Whisper 自动检测语言
- 自定义：输入语言代码（如 ko、ar、hi、pt等）

### 5. 识别管理

**开始识别：**
- 点击"🎤 Start Recognition"开始批量识别
- 实时显示识别进度和输出
- 可点击"🛑 Stop Recognition & Kill Processes"中止

**断点续传：**
- 如果识别中断，重新打开工作区
- 点击"▶️ Resume"继续识别未完成的片段

**重新识别单个片段：**
- 在"🔄 Re-recognize Segment"区域选择片段
- 点击"🎤 Re-recognize"重新识别

### 6. 结果输出

- **SRT字幕**：自动保存在视频同目录下
- **纯文本**：点击"💾 Save Plain Text"导出识别文本
- **工作区**：点击"💾 Save Workspace"保存当前进度

## 界面功能

### 左侧面板
- **文件加载区** - 显示当前加载的文件
- **音频播放器** - 播放控制、进度条、时间刻度快速定位
- **切割点管理** - 标记、查看和删除切割点
- **重新识别** - 选择并重新识别指定片段
- **手动切割** - 指定时间段切割音频
- **临时文件清理** - 清理识别过程产生的临时文件

### 右侧面板
- **模型选择** - 选择 Whisper 识别模型
- **语言设置** - 选择识别语言或自定义语言代码
- **识别控制** - 开始/停止识别任务
- **进度显示** - 实时显示识别进度和输出
- **结果保存** - 保存纯文本识别结果

### 顶部工具栏
- **📁 Open Folder** - 打开工作区文件夹
- **💾 Save Workspace** - 保存当前工作区
- **▶️ Resume** - 恢复中断的识别任务

## 工作区管理

### 什么是工作区？
工作区是一个文件夹，用于保存识别项目的所有数据：
- 视频/音频文件路径
- 切割点信息
- 音频片段文件
- 识别进度
- 已完成的字幕文件

### 工作区结构
```
workspace/
├── workspace_state.json  # 工作区状态文件
├── segments/             # 音频片段目录
└── subtitles/            # 字幕文件目录
```

### 使用场景

**场景1：保存进度**
- 在识别过程中或完成后，点击"💾 Save Workspace"
- 选择文件夹保存工作区
- 所有切割点、片段和识别结果都会保存

**场景2：恢复识别**
- 识别过程意外中断（断网、关机、程序崩溃等）
- 重新打开程序，点击"📁 Open Folder"
- 选择之前的工作区文件夹
- 点击"▶️ Resume"继续识别未完成的片段

**场景3：重新识别**
- 打开已有工作区
- 使用"🔄 Re-recognize Segment"重新识别某些片段
- 或添加"手动切割"的新片段并识别
- 程序会自动重新合并所有字幕

## 字幕合并算法

程序自动合并多段音频的识别结果：
1. 解析每段生成的 SRT 文件
2. 根据切割点计算时间偏移量
3. 调整字幕时间戳
4. 按时间顺序合并并重新编号
5. 输出最终 SRT 文件

**智能合并特性：**
- 自动处理手动切割的片段
- 按时间顺序正确排列所有字幕
- 支持部分片段重新识别后自动更新

## 注意事项

### 切割建议
- 建议在句子间隙或静音处标记切割点
- 避免在单词或句子中间切割
- 长视频建议每 3-5 分钟标记一个切割点
- 使用播放器的时间刻度快速定位

### 模型选择
- 模型越大，识别越准确，但耗时更长
- `base` 模型适合大多数场景
- `turbo` 模型在速度和准确率之间平衡良好
- 中文识别建议使用 `medium` 或以上模型

### 工作区管理
- 建议每次识别都保存工作区，以便中断后恢复
- 工作区文件夹建议放在视频文件同目录下
- 识别完成后可使用"🗑️ Clean Up Temp Files"清理临时文件
- 保留工作区可以随时重新识别单个片段

### 系统要求
- 确保系统已安装 FFmpeg 和 Whisper
- 长视频识别需要较大磁盘空间存储音频片段
- 识别过程中避免关闭程序或系统休眠

### 常见问题
- **识别中断怎么办？** 使用工作区的恢复功能继续识别
- **某段识别不准确？** 使用重新识别功能单独处理该片段
- **需要识别特定时间段？** 使用手动切割功能指定时间范围
- **识别速度慢？** 选择较小的模型，或使用 `turbo` 模型

## 许可证

MIT License
